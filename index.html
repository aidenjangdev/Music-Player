<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>방송부 플레이어</title>
    <link rel="icon" href="assets/icon.ico">
	<style>
		:root {
			--hover: rgba(255,255,255,0.1);
			--hover-close: #e81123;
		}

		html, body {
			width: 100%;
			height: 100%;
			margin: 0;
		}

		body {
			background: transparent;
			color: white;
			font-family: system-ui;
			overflow: hidden;
		}

		.app {
			display: flex;
			width: 100vw;
			height: 100vh;
		}

		.sidebar {
			width: 30vw;
			background-color: #c3c3c3aa;
			border-right: 1px solid #222;
			-webkit-app-region: no-drag;
			display: flex;
			flex-direction: column;
		}

		.sidebar-header {
			padding: 16px;
			border-bottom: 1px solid #222;
		}

		.sidebar-header h2 {
			margin: 0 0 12px 0;
			font-size: 18px;
		}

		.add-file-btn {
			width: 100%;
			padding: 10px;
			background-color: #555;
			color: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-size: 14px;
			transition: all 0.2s ease;
		}

		.add-file-btn:active {
			transform: translateY(0);
		}

		.playlist {
			flex: 1;
			overflow-y: auto;
			padding: 8px;
		}

		.playlist-item {
			padding: 12px;
			margin-bottom: 4px;
			background-color: rgba(255,255,255,0.1);
			border-radius: 5px;
			cursor: pointer;
			transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
			position: relative;
			user-select: none;
			transform-origin: center;
		}

		.playlist-item.reordering {
			transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s ease;
		}

		.playlist-item.active {
			background-color: rgba(255,255,255,0.3);
			box-shadow: 0 0 0 2px rgba(255,255,255,0.4);
		}

		.playlist-item.dragging {
			opacity: 0.5;
			transform: scale(0.95);
			cursor: grabbing;
		}

		.playlist-item.drag-over {
			border-top: 3px solid #fff;
			padding-top: 15px;
			margin-top: 8px;
			animation: dragPulse 0.6s ease-in-out infinite;
		}

		.playlist-item.drag-over-bottom {
			border-bottom: 3px solid #fff;
			padding-bottom: 15px;
			margin-bottom: 8px;
			animation: dragPulseBottom 0.6s ease-in-out infinite;
		}

		@keyframes dragPulse {
			0%, 100% {
				border-top-color: #fff;
				box-shadow: 0 -4px 12px rgba(255,255,255,0.3);
			}
			50% {
				border-top-color: rgba(255,255,255,0.6);
				box-shadow: 0 -4px 20px rgba(255,255,255,0.5);
			}
		}

		@keyframes dragPulseBottom {
			0%, 100% {
				border-bottom-color: #fff;
				box-shadow: 0 4px 12px rgba(255,255,255,0.3);
			}
			50% {
				border-bottom-color: rgba(255,255,255,0.6);
				box-shadow: 0 4px 20px rgba(255,255,255,0.5);
			}
		}

		.playlist-item-name {
			font-size: 14px;
			margin-bottom: 4px;
			transition: transform 0.2s ease;
		}

		.playlist-item-duration {
			font-size: 11px;
			opacity: 0.7;
		}

		.playlist-item:hover::before {
			opacity: 1;
		}

		.main {
			flex: 1;
			display: flex;
			flex-direction: column;
		}

		.titlebar {
			height: 32px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			-webkit-app-region: drag;
		}

		.window-controls {
			display: flex;
			-webkit-app-region: no-drag;
		}

		.btn {
			width: 46px;
			height: 32px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: default;
			transition: all 0.15s ease;
		}

		.btn:hover {
			background: var(--hover);
		}

		.btn.close:hover {
			background: var(--hover-close);
		}

		svg {
			width: 10px;
			height: 10px;
			fill: none;
			stroke: white;
			stroke-width: 1.5;
		}

		.content {
			flex: 1;
			box-sizing: border-box;
			display: flex;
			flex-direction: column;
		}

		.now-playing {
			flex: 1;
			display: flex;
			align-items: center;
			justify-content: center;
			padding: 16px;
			text-align: center;
		}

		.now-playing h1 {
			margin: 0;
			font-size: 24px;
			font-weight: 500;
			cursor: text;
			padding: 8px;
			border-radius: 5px;
			transition: all 0.2s ease;
		}

		.now-playing h1:hover {
			background-color: rgba(255,255,255,0.1);
			transform: scale(1.02);
		}

		.now-playing input {
			margin: 0;
			font-size: 24px;
			font-weight: 500;
			background: transparent;
			border: none;
			color: white;
			text-align: center;
			width: 100%;
			outline: none;
			padding: 8px;
			border-radius: 5px;
			background-color: rgba(255,255,255,0.2);
		}

		.controls-wrapper {
			width: 100%;
		}

		img {
			width: 70px;
			transition: transform 0.2s ease;
		}

		.controls {
			display: flex;
			gap: 16px;
			padding: 0 16px;
			box-sizing: border-box;
		}

		.controls button {
			border-radius: 5vw;
			background-color: #d7d7d77f;
			flex: 1;
			height: 30vh;
			border: none;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s ease;
		}

		.controls button:hover {
			background-color: #e7e7e78f;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(0,0,0,0.2);
		}

		.controls button:hover img {
			transform: scale(1.1);
		}

		.controls button:active {
			transform: translateY(0);
		}

		.range {
			width: 100%;
			-webkit-appearance: none;
			appearance: none;
			height: 4px;
			border-radius: 2px;
			background: linear-gradient(
				to right,
				#ffffff 0%,
				#ffffff var(--value, 0%),
				rgba(255,255,255,0.3) var(--value, 0%),
				rgba(255,255,255,0.3) 100%
			);
			outline: none;
			cursor: pointer;
			transition: height 0.15s ease;
		}

		.range:hover {
			height: 6px;
		}

		.range::-webkit-slider-thumb {
			-webkit-appearance: none;
			width: 14px;
			height: 14px;
			border-radius: 50%;
			background: white;
			box-shadow: 0 0 0 4px rgba(255,255,255,0.15);
			transition: all 0.15s ease;
		}

		.range::-webkit-slider-thumb:hover {
			transform: scale(1.2);
			box-shadow: 0 0 0 6px rgba(255,255,255,0.25);
		}

		.range::-webkit-slider-thumb:active {
			transform: scale(1.3);
			box-shadow: 0 0 0 8px rgba(255,255,255,0.3);
		}

		.progress {
			padding: 0 16px 12px 16px;
		}

		.progress-bar-wrapper {
			display: flex;
			align-items: center;
			gap: 12px;
		}

		.progress input {
			flex: 1;
		}

		.time-display {
			font-size: 12px;
			white-space: nowrap;
			min-width: 40px;
			transition: transform 0.2s ease;
		}

		.time-display:hover {
			transform: scale(1.05);
		}

		.volume {
			display: flex;
			align-items: center;
			gap: 12px;
			padding: 16px;
			box-sizing: border-box;
		}

		.volume span {
			width: 48px;
			text-align: right;
			font-size: 14px;
			transition: transform 0.2s ease;
		}

		.volume span:hover {
			transform: scale(1.05);
		}

		#fileInput {
			display: none;
		}

		.playlist::-webkit-scrollbar {
			width: 8px;
		}

		.playlist::-webkit-scrollbar-track {
			background: rgba(0,0,0,0.1);
			border-radius: 4px;
		}

		.playlist::-webkit-scrollbar-thumb {
			background: rgba(255,255,255,0.3);
			border-radius: 4px;
			transition: background 0.2s ease;
		}

		.playlist::-webkit-scrollbar-thumb:hover {
			background: rgba(255,255,255,0.5);
		}

		.playlist-item-number {
			position: absolute;
			right: 12px;
			top: 12px;
			font-size: 3vh;
			opacity: 0.5;
			font-weight: 600;
            display:none;
		}

		.delete-btn {
			position: absolute;
			right: 8px;
			bottom: 8px;
			width: 28px;
			height: 28px;
			background-color: #e81123;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			opacity: 0;
			transform: scale(0.8);
			transition: all 0.2s ease;
			z-index: 10;
		}

		.playlist-item:hover .delete-btn {
			opacity: 1;
			transform: scale(1);
		}

		.delete-btn:hover {
			background-color: #c40d1a;
			transform: scale(1.1);
			box-shadow: 0 2px 8px rgba(232, 17, 35, 0.4);
		}

		.delete-btn:active {
			transform: scale(0.95);
		}

		.delete-btn svg {
			width: 14px;
			height: 14px;
			stroke: white;
			stroke-width: 2;
		}

		.modal-overlay {
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background: rgba(0, 0, 0, 0.7);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
			opacity: 0;
			pointer-events: none;
			transition: opacity 0.3s ease;
			backdrop-filter: blur(4px);
		}

		.modal-overlay.show {
			opacity: 1;
			pointer-events: all;
		}

		.modal {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			border-radius: 16px;
			padding: 32px;
			max-width: 400px;
			width: 90%;
			box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
			transform: scale(0.9) translateY(-20px);
			transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
		}

		.modal-overlay.show .modal {
			transform: scale(1) translateY(0);
		}

		.modal-header {
			display: flex;
			align-items: center;
			gap: 12px;
			margin-bottom: 20px;
		}

		.modal-icon {
			width: 48px;
			height: 48px;
			background: rgba(232, 17, 35, 0.2);
			border-radius: 12px;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.modal-icon svg {
			width: 24px;
			height: 24px;
			stroke: #e81123;
			stroke-width: 2;
		}

		.modal-title {
			font-size: 24px;
			font-weight: 600;
			margin: 0;
			color: white;
		}

		.modal-content {
			margin-bottom: 24px;
		}

		.modal-text {
			font-size: 16px;
			color: rgba(255, 255, 255, 0.9);
			line-height: 1.5;
			margin: 0 0 8px 0;
		}

		.modal-song-name {
			font-size: 18px;
			font-weight: 600;
			color: white;
			background: rgba(255, 255, 255, 0.15);
			padding: 12px 16px;
			border-radius: 8px;
			margin-top: 12px;
			word-break: break-word;
		}

		.modal-buttons {
			display: flex;
			gap: 12px;
		}

		.modal-btn {
			flex: 1;
			padding: 14px 24px;
			border: none;
			border-radius: 10px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.2s ease;
		}

		.modal-btn-cancel {
			background: rgba(255, 255, 255, 0.2);
			color: white;
		}

		.modal-btn-cancel:hover {
			background: rgba(255, 255, 255, 0.3);
			transform: translateY(-2px);
		}

		.modal-btn-delete {
			background: #e81123;
			color: white;
		}

		.modal-btn-delete:hover {
			background: #c40d1a;
			transform: translateY(-2px);
			box-shadow: 0 4px 12px rgba(232, 17, 35, 0.4);
		}

		.modal-btn:active {
			transform: translateY(0);
		}
	</style>
    
</head>

<body>
	<div class="app">
		<div class="sidebar">
			<div class="sidebar-header">
				<h2>축제노래잘좀틀자~~~</h2>
				<button class="add-file-btn" onclick="selectFiles()">
					+ 노래추가
				</button>
			</div>
			<div class="playlist" id="playlist"></div>
		</div>

		<div class="main">
			<div class="titlebar">
				<div></div>
				<div class="window-controls">
					<div class="btn" onclick="window.windowControls.minimize()">
						<svg viewBox="0 0 10 10"><line x1="1" y1="5" x2="9" y2="5"/></svg>
					</div>
					<div class="btn" onclick="window.windowControls.maximize()">
						<svg viewBox="0 0 10 10"><rect x="1.5" y="1.5" width="7" height="7"/></svg>
					</div>
					<div class="btn close" onclick="window.windowControls.close()">
						<svg viewBox="0 0 10 10">
							<line x1="2" y1="2" x2="8" y2="8"/>
							<line x1="8" y1="2" x2="2" y2="8"/>
						</svg>
					</div>
				</div>
			</div>

			<div class="content">
				<div class="now-playing">
					<h1 id="nowPlayingTitle">재생 중인 곡이 없음!!!</h1>
				</div>

				<audio id="nowAudio"></audio>

				<div class="controls-wrapper">
					<div class="progress">
						<div class="progress-bar-wrapper">
							<span class="time-display" id="currentTime">0:00</span>
							<input
								id="progressBar"
								class="range"
								type="range"
								min="0"
								max="100"
								value="0"
							/>
							<span class="time-display" id="totalTime">0:00</span>
						</div>
					</div>

					<div class="controls" style="padding-bottom: 16px;">
						<button id="gotostart">
							<img src="assets/tostart.png">
						</button>
						<button id="playpauseButton">
							<img src="assets/play.png">
						</button>
					</div>

					<div class="volume" style="border-top: 1px solid rgba(255,255,255,0.2);">
                        <span style="width: 80px; text-align: left;">음량</span>
						<input
							id="volumeSlider"
							class="range"
							type="range"
							min="0"
							max="100"
							value="0"
						/>
						<span id="volumeValue" style="width: 60px;">0%</span>
					</div>

					<div class="volume" style="padding-top: 16px;">
						<span style="width: 80px; text-align: left;">베이스</span>
						<input
							id="bassSlider"
							class="range"
							type="range"
							min="-25"
							max="25"
							value="0"
							step="1"
						/>
						<span id="bassValue" style="width: 60px;">0dB</span>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="modal-overlay" id="deleteModal">
		<div class="modal">
			<div class="modal-header">
				<div class="modal-icon">
					<svg viewBox="0 0 24 24" fill="none">
						<path d="M12 9v4m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z" stroke-linecap="round" stroke-linejoin="round"/>
					</svg>
				</div>
				<h2 class="modal-title">곡 삭제</h2>
			</div>
			<div class="modal-content">
				<p class="modal-text">이 곡을 삭제하시겠습니까?</p>
				<p class="modal-text" style="font-size: 14px; opacity: 0.7;">파일이 완전히 삭제됩니다.</p>
				<div class="modal-song-name" id="deleteSongName"></div>
			</div>
			<div class="modal-buttons">
				<button class="modal-btn modal-btn-cancel" onclick="closeDeleteModal()">취소</button>
				<button class="modal-btn modal-btn-delete" onclick="confirmDelete()">삭제</button>
			</div>
		</div>
	</div>

	<script>
		const audio = document.getElementById('nowAudio');
        const playBtn = document.getElementById('playpauseButton');
        const playImg = playBtn.querySelector('img');
        const gotoStartBtn = document.getElementById('gotostart');
        const playlist = document.getElementById('playlist');
        const nowPlayingTitle = document.getElementById('nowPlayingTitle');

        const progress = document.getElementById('progressBar');
        const volume = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        const currentTime = document.getElementById('currentTime');
        const totalTime = document.getElementById('totalTime');

        let isPlaying = false;
        let audioFiles = [];
        let currentIndex = -1;
        let isEditingTitle = false;
        let draggedIndex = null;
        let deleteTargetIndex = null;
        let dropPosition = 'before';
        let lastDropTarget = null;

        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const audioSource = audioContext.createMediaElementSource(audio);
        const bassFilter = audioContext.createBiquadFilter();
        
        bassFilter.type = 'lowshelf';
        bassFilter.frequency.value = 200;
        bassFilter.gain.value = 0;
        
        // 오디오 라우팅: audio → bassFilter → destination
        audioSource.connect(bassFilter);
        bassFilter.connect(audioContext.destination);

        function removeExtension(filename) {
            return filename.replace(/\.[^/.]+$/, '');
        }

        function formatTime(seconds) {
            if (isNaN(seconds)) return '0:00';
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function loadSavedData() {
            try {
                const data = await window.fileSystem.loadData();
                if (data && data.audioFiles) {
                    audioFiles = data.audioFiles.map(file => ({
                        ...file,
                        volume: file.volume !== undefined ? file.volume : 0,
                        currentTime: file.currentTime !== undefined ? file.currentTime : 0,
                        bass: file.bass !== undefined ? file.bass : 0
                    }));
                    renderPlaylist();
                }
            } catch (error) {
                console.error('데이터 로드 실패:', error);
            }
        }

        async function saveData() {
            try {
                await window.fileSystem.saveData({ audioFiles });
            } catch (error) {
                console.error('데이터 저장 실패:', error);
            }
        }

        async function selectFiles() {
            try {
                const result = await window.fileSystem.selectFiles();
                
                if (result.canceled) {
                    return;
                }
                
                for (const file of result.files) {
                    if (file.success) {
                        audioFiles.push({
                            name: removeExtension(file.fileName),
                            originalName: file.fileName,
                            fileName: file.fileName,
                            duration: 0,
                            volume: 0,
                            currentTime: 0,
                            bass: 0
                        });
                    } else {
                        console.error('파일 복사 실패:', file.error);
                    }
                }
                
                renderPlaylist();
                await saveData();
            } catch (error) {
                console.error('파일 선택 실패:', error);
            }
        }

        function renderPlaylist(animate = false) {
            playlist.innerHTML = '';
            audioFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'playlist-item';
                item.draggable = true;
                item.dataset.index = index;
                
                if (animate) {
                    item.classList.add('reordering');
                    item.style.transform = 'scale(0.95)';
                    item.style.opacity = '0';
                    
                    setTimeout(() => {
                        item.style.transform = 'scale(1)';
                        item.style.opacity = '1';
                    }, index * 30);
                    
                    setTimeout(() => {
                        item.classList.remove('reordering');
                    }, 400 + index * 30);
                }
                
                if (index === currentIndex) {
                    item.classList.add('active');
                }
                item.innerHTML = `
                    <div class="playlist-item-number">#${index + 1}</div>
                    <div class="playlist-item-name">${file.name}</div>
                    <div class="playlist-item-duration">${formatTime(file.duration)}</div>
                    <button class="delete-btn">
                        <svg viewBox="0 0 24 24">
                            <path d="M3 6h18M8 6V4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2m3 0v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6h14zM10 11v6m4-6v6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                `;
                
                const deleteBtn = item.querySelector('.delete-btn');
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTrack(index, e);
                });
                
                item.onclick = (e) => {
                    if (!item.classList.contains('dragging') && !e.target.closest('.delete-btn')) {
                        playTrack(index);
                    }
                };
                
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                item.addEventListener('dragover', handleDragOver);
                item.addEventListener('drop', handleDrop);
                item.addEventListener('dragleave', handleDragLeave);
                
                playlist.appendChild(item);
            });
        }

        // 드래그 시작
        function handleDragStart(e) {
            draggedIndex = parseInt(e.target.dataset.index);
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.innerHTML);
            lastDropTarget = null;
        }

        // 드래그 종료
        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            document.querySelectorAll('.playlist-item').forEach(item => {
                item.classList.remove('drag-over', 'drag-over-bottom');
            });
            lastDropTarget = null;
        }

        // 드래그 오버
        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            
            const targetItem = e.target.closest('.playlist-item');
            if (targetItem) {
                const targetIndex = parseInt(targetItem.dataset.index);
                if (targetIndex !== undefined && targetIndex !== draggedIndex) {
                    // 마우스 위치가 아이템의 위쪽 절반인지 아래쪽 절반인지 판단
                    const rect = targetItem.getBoundingClientRect();
                    const mouseY = e.clientY;
                    const itemMiddle = rect.top + rect.height / 2;
                    
                    const newPosition = mouseY < itemMiddle ? 'before' : 'after';
                    
                    // 타겟이나 위치가 변경된 경우에만 클래스 업데이트
                    if (lastDropTarget !== targetItem || dropPosition !== newPosition) {
                        // 모든 drag-over 클래스 제거
                        document.querySelectorAll('.playlist-item').forEach(item => {
                            item.classList.remove('drag-over', 'drag-over-bottom');
                        });
                        
                        if (newPosition === 'before') {
                            // 위쪽 절반 - 위에 삽입
                            targetItem.classList.add('drag-over');
                        } else {
                            // 아래쪽 절반 - 아래에 삽입
                            targetItem.classList.add('drag-over-bottom');
                        }
                        
                        dropPosition = newPosition;
                        lastDropTarget = targetItem;
                    }
                }
            }
            
            return false;
        }

        // 드래그 떠남
        function handleDragLeave(e) {
            const targetItem = e.target.closest('.playlist-item');
            if (targetItem) {
                // 실제로 아이템을 벗어났는지 확인
                const rect = targetItem.getBoundingClientRect();
                if (e.clientY < rect.top || e.clientY >= rect.bottom) {
                    targetItem.classList.remove('drag-over', 'drag-over-bottom');
                }
            }
        }

        // 드롭
        async function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            const targetItem = e.target.closest('.playlist-item');
            const dropIndex = parseInt(targetItem?.dataset.index);
            
            if (dropIndex !== undefined && draggedIndex !== null && draggedIndex !== dropIndex) {
                // 배열에서 이동
                const draggedItem = audioFiles[draggedIndex];
                audioFiles.splice(draggedIndex, 1);
                
                // 실제 삽입 위치 계산
                let insertIndex;
                if (dropPosition === 'before') {
                    // 위쪽에 삽입
                    insertIndex = dropIndex > draggedIndex ? dropIndex - 1 : dropIndex;
                } else {
                    // 아래쪽에 삽입
                    insertIndex = dropIndex >= draggedIndex ? dropIndex : dropIndex + 1;
                }
                
                audioFiles.splice(insertIndex, 0, draggedItem);
                
                // currentIndex 업데이트
                if (currentIndex === draggedIndex) {
                    currentIndex = insertIndex;
                } else if (draggedIndex < currentIndex && insertIndex >= currentIndex) {
                    currentIndex--;
                } else if (draggedIndex > currentIndex && insertIndex <= currentIndex) {
                    currentIndex++;
                }
                
                renderPlaylist(true); // 애니메이션 활성화
                await saveData();
            }
            
            return false;
        }

        // 트랙 선택
        async function playTrack(index) {
            if (currentIndex >= 0 && currentIndex < audioFiles.length) {
                audioFiles[currentIndex].currentTime = audio.currentTime;
                await saveData();
            }
            
            audio.pause();
            isPlaying = false;
            playImg.src = "assets/play.png";
            
            currentIndex = index;
            const file = audioFiles[index];
            
            try {
                const filePath = await window.fileSystem.getFilePath(file.fileName);
                
                audio.src = filePath;
                audio.load();
                
                const trackVolume = file.volume !== undefined ? file.volume : 0;
                volume.value = trackVolume;
                audio.volume = trackVolume / 100;
                volumeValue.textContent = trackVolume + "%";
                volume.style.setProperty("--value", trackVolume + "%");
                
                // 베이스 설정 복원
                const trackBass = file.bass !== undefined ? file.bass : 0;
                bassSlider.value = trackBass;
                bassFilter.gain.value = trackBass;
                bassValue.textContent = (trackBass > 0 ? '+' : '') + trackBass + 'dB';
                const bassPercent = ((trackBass - (-25)) / 50) * 100;
                bassSlider.style.setProperty("--value", bassPercent + "%");
                
                nowPlayingTitle.textContent = file.name;
                renderPlaylist();
            } catch (error) {
                console.error('파일 로드 실패:', error);
            }
        }

        audio.onloadstart = () => {
            progress.value = 0;
            progress.style.setProperty("--value", "0%");
            currentTime.textContent = "0:00";
        };

        audio.onloadedmetadata = async () => {
            totalTime.textContent = formatTime(audio.duration);
            if (currentIndex >= 0) {
                audioFiles[currentIndex].duration = audio.duration;
                
                const savedTime = audioFiles[currentIndex].currentTime || 0;
                
                setTimeout(() => {
                    audio.currentTime = savedTime;
                    
                    const percent = (savedTime / audio.duration) * 100;
                    progress.value = percent;
                    progress.style.setProperty("--value", percent + "%");
                    currentTime.textContent = formatTime(savedTime);
                }, 100);
                
                renderPlaylist();
                await saveData();
            }
        };

        playBtn.onclick = async () => {
            if (currentIndex < 0) return;
            if (isPlaying) {
                audio.pause();
                playImg.src = "assets/play.png";
                audioFiles[currentIndex].currentTime = audio.currentTime;
                await saveData();
            } else {
                audio.play();
                playImg.src = "assets/pause.png";
            }
            isPlaying = !isPlaying;
        };

        gotoStartBtn.onclick = async () => {
            audio.pause();
            audio.currentTime = 0;
            playImg.src = "assets/play.png";
            isPlaying = false;
            
            if (currentIndex >= 0) {
                audioFiles[currentIndex].currentTime = 0;
                await saveData();
            }
        };

        progress.oninput = async () => {
            audio.currentTime = (progress.value / 100) * audio.duration;
            
            if (currentIndex >= 0) {
                audioFiles[currentIndex].currentTime = audio.currentTime;
                await saveData();
            }
        };

        let lastSaveTime = 0;
        audio.ontimeupdate = async () => {
            const percent = (audio.currentTime / audio.duration) * 100;
            progress.value = percent;
            progress.style.setProperty("--value", percent + "%");
            currentTime.textContent = formatTime(audio.currentTime);
            
            const currentSecond = Math.floor(audio.currentTime);
            if (currentIndex >= 0 && currentSecond !== lastSaveTime) {
                lastSaveTime = currentSecond;
                audioFiles[currentIndex].currentTime = audio.currentTime;
                await saveData();
            }
        };

        volume.oninput = async () => {
            const v = volume.value;
            audio.volume = v / 100;
            volumeValue.textContent = v + "%";
            volume.style.setProperty("--value", v + "%");
            
            if (currentIndex >= 0) {
                audioFiles[currentIndex].volume = parseInt(v);
                await saveData();
            }
        };

        volume.style.setProperty("--value", "0%");

        // 베이스 슬라이더
        const bassSlider = document.getElementById('bassSlider');
        const bassValue = document.getElementById('bassValue');

        bassSlider.oninput = async () => {
            const gain = parseFloat(bassSlider.value);
            bassFilter.gain.value = gain;
            bassValue.textContent = (gain > 0 ? '+' : '') + gain + 'dB';
            
            const percent = ((gain - (-25)) / 50) * 100; // -25~25 → 0~100%
            bassSlider.style.setProperty("--value", percent + "%");
            
            if (currentIndex >= 0) {
                audioFiles[currentIndex].bass = gain;
                await saveData();
            }
        };

        // 초기값 설정 (0dB = 50%)
        bassSlider.style.setProperty("--value", "50%");

        // AudioContext resume (브라우저 autoplay 정책 대응)
        playBtn.addEventListener('click', () => {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        });

        nowPlayingTitle.onclick = () => {
            if (currentIndex < 0 || isEditingTitle) return;
            isEditingTitle = true;
            const currentName = audioFiles[currentIndex].name;
            
            // 래퍼 div 생성
            const wrapper = document.createElement('div');
            wrapper.className = 'now-playing-input-wrapper';
            wrapper.innerHTML = `<input type="text" id="titleInput" value="${currentName}" />`;
            
            // h1 숨기고 래퍼 추가
            nowPlayingTitle.style.display = 'none';
            nowPlayingTitle.parentElement.appendChild(wrapper);
            
            const input = document.getElementById('titleInput');
            input.focus();
            input.select();

            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    saveTitle();
                } else if (e.key === 'Escape') {
                    cancelEdit();
                }
            };

            input.onblur = () => {
                setTimeout(saveTitle, 100);
            };
        };

        async function saveTitle() {
            if (!isEditingTitle) return;
            const input = document.getElementById('titleInput');
            if (input) {
                const newName = input.value.trim();
                if (newName) {
                    audioFiles[currentIndex].name = newName;
                }
                
                // 래퍼 제거하고 h1 다시 표시
                const wrapper = input.parentElement;
                wrapper.remove();
                nowPlayingTitle.textContent = audioFiles[currentIndex].name;
                nowPlayingTitle.style.display = 'block';
                
                renderPlaylist();
                await saveData();
            }
            isEditingTitle = false;
        }

        function cancelEdit() {
            if (!isEditingTitle) return;
            
            // 래퍼 제거하고 h1 다시 표시
            const wrapper = document.querySelector('.now-playing-input-wrapper');
            if (wrapper) wrapper.remove();
            nowPlayingTitle.style.display = 'block';
            
            isEditingTitle = false;
        }

        // 트랙 삭제 모달 열기
        async function deleteTrack(index, event) {
            event.stopPropagation();
            
            deleteTargetIndex = index;
            const file = audioFiles[index];
            
            document.getElementById('deleteSongName').textContent = file.name;
            document.getElementById('deleteModal').classList.add('show');
        }

        // 삭제 모달 닫기
        function closeDeleteModal() {
            document.getElementById('deleteModal').classList.remove('show');
            deleteTargetIndex = null;
        }

        // 삭제 확인
        async function confirmDelete() {
            if (deleteTargetIndex === null) return;
            
            const index = deleteTargetIndex;
            const file = audioFiles[index];
            
            closeDeleteModal();
            
            try {
                console.log('삭제 시도:', file.fileName);
                
                // 파일 시스템에서 파일 삭제
                if (window.fileSystem && window.fileSystem.deleteFile) {
                    await window.fileSystem.deleteFile(file.fileName);
                    console.log('파일 삭제 성공');
                } else {
                    console.error('window.fileSystem.deleteFile 메서드가 없습니다.');
                    throw new Error('삭제 기능이 구현되지 않았습니다.');
                }
                
                // 현재 재생 중인 트랙이 삭제되는 경우
                if (index === currentIndex) {
                    audio.pause();
                    audio.src = '';
                    isPlaying = false;
                    playImg.src = "assets/play.png";
                    nowPlayingTitle.textContent = '재생 중인 곡이 없음!!!';
                    currentIndex = -1;
                } else if (index < currentIndex) {
                    // 삭제된 트랙이 현재 트랙보다 앞에 있으면 인덱스 조정
                    currentIndex--;
                }
                
                // 배열에서 제거
                audioFiles.splice(index, 1);
                
                // UI 업데이트 및 저장
                renderPlaylist();
                await saveData();
                
            } catch (error) {
                console.error('파일 삭제 실패:', error);
                alert('파일 삭제에 실패했습니다: ' + error.message);
            }
        }

        // 모달 외부 클릭 시 닫기
        document.getElementById('deleteModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeDeleteModal();
            }
        });

        // ESC 키로 모달 닫기
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('deleteModal');
                if (modal.classList.contains('show')) {
                    closeDeleteModal();
                }
            }
        });

        loadSavedData();
    </script>
</body>
</html>